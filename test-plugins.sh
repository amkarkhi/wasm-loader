#!/bin/bash

# Test script for WASM Core with multiple plugins

set -e

echo "?? WASM Core Plugin Testing Suite"
echo "??????????????????????????????????????????"
echo ""
echo "??  Make sure the core server is running in another terminal:"
echo "   cargo run -p wasm-core"
echo ""
read -p "Press Enter when the server is ready..."
echo ""

CLIENT="cargo run -p wasm-client --"

# Test 1: Load all plugins
echo "??????????????????????????????????????????"
echo "?? TEST 1: Loading all plugins"
echo "??????????????????????????????????????????"
echo ""

echo "Loading reverser.wasm..."
REVERSER_OUTPUT=$($CLIENT load --path ./plugins/reverser.wasm)
echo "$REVERSER_OUTPUT"
REVERSER_ID=$(echo "$REVERSER_OUTPUT" | grep "Binary ID:" | awk '{print $3}')
echo ""

echo "Loading uppercase.wasm..."
UPPERCASE_OUTPUT=$($CLIENT load --path ./plugins/uppercase.wasm)
echo "$UPPERCASE_OUTPUT"
UPPERCASE_ID=$(echo "$UPPERCASE_OUTPUT" | grep "Binary ID:" | awk '{print $3}')
echo ""

echo "Loading counter.wasm..."
COUNTER_OUTPUT=$($CLIENT load --path ./plugins/counter.wasm)
echo "$COUNTER_OUTPUT"
COUNTER_ID=$(echo "$COUNTER_OUTPUT" | grep "Binary ID:" | awk '{print $3}')
echo ""

echo "Loading rot13.wasm..."
ROT13_OUTPUT=$($CLIENT load --path ./plugins/rot13.wasm)
echo "$ROT13_OUTPUT"
ROT13_ID=$(echo "$ROT13_OUTPUT" | grep "Binary ID:" | awk '{print $3}')
echo ""

echo "Loading env-reader.wasm..."
ENV_READER=$($CLIENT load --path ./plugins/env-reader.wasm)
echo "$ENV_READER"
ENV_READER_ID=$(echo "$ENV_READER" | grep "Binary ID:" | awk '{print $3}')
echo ""


# Test 2: List all loaded binaries
echo "??????????????????????????????????????????"
echo "?? TEST 2: List all loaded binaries"
echo "??????????????????????????????????????????"
echo ""
$CLIENT list
echo ""

# Test 3: Execute each plugin individually
echo "??????????????????????????????????????????"
echo "?? TEST 3: Execute each plugin individually"
echo "??????????????????????????????????????????"
echo ""

TEST_INPUT="Hello World"

echo "3.1 - Reverser Plugin"
echo "Input: '$TEST_INPUT'"
$CLIENT execute --binary-id "$REVERSER_ID" --input "$TEST_INPUT"
echo ""

echo "3.2 - Uppercase Plugin"
echo "Input: '$TEST_INPUT'"
$CLIENT execute --binary-id "$UPPERCASE_ID" --input "$TEST_INPUT"
echo ""

echo "3.3 - Counter Plugin"
echo "Input: '$TEST_INPUT'"
$CLIENT execute --binary-id "$COUNTER_ID" --input "$TEST_INPUT"
echo ""

echo "3.4 - ROT13 Plugin"
echo "Input: '$TEST_INPUT'"
$CLIENT execute --binary-id "$ROT13_ID" --input "$TEST_INPUT"
echo ""

echo "3.5 - Env Reader Plugin"
echo "Input: '$TEST_INPUT'"
$CLIENT execute --binary-id "$ENV_READER_ID" --input "$TEST_INPUT"
echo ""


# Test 4: Chain plugins together
echo "??????????????????????????????????????????"
echo "??  TEST 4: Chain plugins together"
echo "??????????????????????????????????????????"
echo ""

echo "4.1 - Chain: Uppercase ? Reverser"
echo "Input: 'hello' ? UPPERCASE ? REVERSE"
$CLIENT chain --binary-ids "$UPPERCASE_ID,$REVERSER_ID" --input "hello"
echo ""

echo "4.2 - Chain: ROT13 ? Uppercase"
echo "Input: 'secret' ? ROT13 ? UPPERCASE"
$CLIENT chain --binary-ids "$ROT13_ID,$UPPERCASE_ID" --input "secret"
echo ""

echo "4.3 - Chain: Uppercase ? ROT13 ? Reverser"
echo "Input: 'test' ? UPPERCASE ? ROT13 ? REVERSE"
$CLIENT chain --binary-ids "$UPPERCASE_ID,$ROT13_ID,$REVERSER_ID" --input "test"
echo ""

echo "4.4 - Chain: Reverser ? Reverser (double reverse = original)"
echo "Input: 'palindrome' ? REVERSE ? REVERSE"
$CLIENT chain --binary-ids "$REVERSER_ID,$REVERSER_ID" --input "palindrome"
echo ""

# Test 5: Different input types
echo "??????????????????????????????????????????"
echo "?? TEST 5: Different input types"
echo "??????????????????????????????????????????"
echo ""

echo "5.1 - Counter with mixed content"
$CLIENT execute --binary-id "$COUNTER_ID" --input "Hello123 World456!"
echo ""

echo "5.2 - ROT13 with sentence"
$CLIENT execute --binary-id "$ROT13_ID" --input "The quick brown fox jumps over the lazy dog"
echo ""

echo "5.3 - Reverser with emojis (if supported)"
$CLIENT execute --binary-id "$REVERSER_ID" --input "Hello ?? World ??"
echo ""

# Test 6: Performance test
echo "??????????????????????????????????????????"
echo "? TEST 6: Performance test (10 rapid executions)"
echo "??????????????????????????????????????????"
echo ""

echo "Executing reverser 10 times..."
START=$(date +%s%N)
for i in {1..10}; do
    $CLIENT execute --binary-id "$REVERSER_ID" --input "Performance test $i" > /dev/null 2>&1
done
END=$(date +%s%N)
DURATION=$(( (END - START) / 1000000 ))
echo "? Completed 10 executions in ${DURATION}ms"
echo "   Average: $((DURATION / 10))ms per execution"
echo ""

# Test 7: List binaries again (should still be loaded)
echo "??????????????????????????????????????????"
echo "?? TEST 7: Verify binaries still loaded"
echo "??????????????????????????????????????????"
echo ""
$CLIENT list
echo ""

# Summary
echo "??????????????????????????????????????????"
echo "? All tests completed successfully!"
echo "??????????????????????????????????????????"
echo ""
echo "?? Summary:"
echo "  ? 4 plugins loaded"
echo "  ? Individual execution: ?"
echo "  ? Plugin chaining: ?"
echo "  ? Different inputs: ?"
echo "  ? Performance: ?"
echo ""
echo "?? Your WASM Core is working perfectly!"
echo ""
echo "?? Try your own tests:"
echo "   $CLIENT execute --binary-id $REVERSER_ID --input \"Your text here\""
echo "   $CLIENT chain --binary-ids $UPPERCASE_ID,$REVERSER_ID --input \"chain test\""
